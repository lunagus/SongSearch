<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Songsearch</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2rem;
      background: #f9f9f9;
      text-align: center;
    }
    h1 {
      color: #109790fd;
    }
    input[type="text"] {
      padding: 0.5rem;
      width: 60%;
      max-width: 400px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    select {
      padding: 0.5rem;
      font-size: 1rem;
      margin-left: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    button {
      padding: 0.5rem 1rem;
      font-size: 1rem;
      margin-left: 10px;
      background-color: #109790fd;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      background-color: #1dbe73;
    }
  </style>
</head>
<body>
  <h1>Songsearch</h1>
  <a href="/login">
    <button id="spotifyConnectBtn">Connect to Spotify</button>
  </a>
  <br/><br/>
  <input type="text" id="songLink" placeholder="Enter a Spotify or Deezer track link..." />
  <select id="targetPlatform">
    <option value="deezer">Deezer</option>
    <option value="spotify">Spotify</option>
  </select>
  <button onclick="convert()">Convert Track</button>
  <br/><br/>
  <input type="text" id="playlistLink" placeholder="Enter a Deezer playlist link..." style="width:60%;max-width:400px;" />
  <button onclick="convertPlaylist()">Convert Playlist to Spotify</button>
  <br/><br/>
  <div id="feedback" style="color:#d9534f;font-weight:bold;"></div>
  <div id="progress" style="margin-top:1em;font-weight:bold;"></div>
  <script>
    // Extract session token from URL if present
    let session = null;
    if (window.location.search.includes('session=')) {
      session = new URLSearchParams(window.location.search).get('session');
      localStorage.setItem('spotify_session', session);
      // Clean up URL
      window.history.replaceState({}, document.title, window.location.pathname);
    } else {
      session = localStorage.getItem('spotify_session');
    }

    function convert() {
      const link = document.getElementById('songLink').value.trim();
      const to = document.getElementById('targetPlatform').value;
      if (!link) {
        showFeedback('Please enter a track link!');
        return;
      }
      const url = `/convert?link=${encodeURIComponent(link)}&to=${encodeURIComponent(to)}`;
      window.location.href = url;
    }

    function convertPlaylist() {
      const link = document.getElementById('playlistLink').value.trim();
      if (!link) {
        showFeedback('Please enter a Deezer playlist link!');
        return;
      }
      if (!session) {
        showFeedback('Please connect to Spotify first!');
        return;
      }
      // Listen for progress updates
      listenForProgress(session);
      // Redirect to backend for playlist conversion
      const url = `/convert-playlist?link=${encodeURIComponent(link)}&session=${encodeURIComponent(session)}`;
      window.location.href = url;
    }

    function listenForProgress(session) {
      const progressDiv = document.getElementById('progress');
      progressDiv.textContent = 'Starting...';
      const evtSource = new EventSource(`/progress/${session}`);
      evtSource.onmessage = function(event) {
        const data = JSON.parse(event.data);
        if (data.stage === 'Error') {
          progressDiv.textContent = 'Error: ' + (data.error || 'Unknown error');
          evtSource.close();
        } else if (data.stage === 'Done') {
          progressDiv.textContent = 'Done!';
          evtSource.close();
        } else if (data.stage) {
          if (data.total && data.total > 0) {
            progressDiv.textContent = `${data.stage} (${data.current} / ${data.total})`;
          } else {
            progressDiv.textContent = data.stage;
          }
        }
      };
      evtSource.onerror = function() {
        progressDiv.textContent = 'Connection lost.';
        evtSource.close();
      };
    }

    function showFeedback(msg) {
      document.getElementById('feedback').textContent = msg;
    }
  </script>
</body>
</html>